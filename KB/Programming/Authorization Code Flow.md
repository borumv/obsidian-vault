---
created: Thursday 1st June 2023 09:53
Last modified: Thursday 1st June 2023 09:53
Aliases: authorization code flow oauth2
Tags: programming
---

Это самый популярный процесс авторизации в [[oAuth2]]. 
У нас есть три 'сущности' - *Клиент*, который хочет авторизоваться, *Auth-client*, которое является нашим приложением, *Auth-server*, сервер, за счёт которого мы хотим авторизоваться (google, github etc.)

1. Вместо того, чтобы вводить логин и пароль, пользователь говорит *Auth client*, что хочет авторизоваться с помощью *OAuth*
2. *Auth client* возвращает response с кодом *302* и *url*, где будет проходить [[авторизация]] пользователя. Вот основные данные, которые возвращаются вместе с response:
**`client_id`** - username нашего *Auth client*
**`redirect_uri`** - это uri нашего *Auth client*, именно его нам возвращает *Aurh server* на шаге 6
**`scope`**
**`response_type=code`** - какой именно flow, мы хотим использовать
3. *Клиент* по переданному *url* попадает на *Auth server* 
4. *Auth server* возвращает свою форму логина и пароля 
5. *Клиент* вводи логин/пароль. Если он отправляет неверные *credential*, то ему предоставляется возможно ввести всё *заново*. Цикл может осуществляться довольно долго, пока пользователь не введёт верные данные
6. *Auth server* возвращает response с кодом 302 и *redirect_uri*, который мы отправляли с *Auth client*. Вместе с этим передаются несколько дополнительных параметров:
**`code`**(authorization code) - это результат взаимодействия с *Auth сервером*, именно из-этого наш flow так называется.
**`scope`**
**`state`**
7. *Клиент* переходит по *redirect_uri* и передаёт нашему *Auth клиенту* переданный *code*
8. На стороне *Auth клиента происходит запрос*, который не видит *Клиент* на сторону *Auth сервера*, чтобы получить необходимые токены. Мы передаём следующие данные:
- **`Authorization: base64(clident_id, client_secret)`** - username и password нашего **Auth клиента**
- **`code (authorization code)`**
- **`redirect_uri`**
9. Если всё валидно, то *Auth сервер* возвращает нашему *Auth клиенту* статус *200* с токенами:
- **`access_token`(authorities)** - строка в специальном виде, которая хранит все [[Authorities]](роли) нашего *Клиента*. Если нам нужно какие-то данные помимо ролей (id пользователя etc.) то мы должны использовать протокол [[OpenID Connect]]
- **`refresh_token`(optional)**