---
tags: [video]
---

Нужно расписать по транзакциям, а именно об их свойствах:
- атомарность
- согласованность
- изолированность
- долговечность



Про уровни изоляции транзакции. Их всего 4 штуки
SHOW default_transaction_isolation; -  чтобы посмотреть транзакцию

Указать уровень тразнзакции:
```sql
SET TRANSACTION ISOLATION LEVEL
```

---
TCL - Transaction Control Language
==Для того чтобы начать транзакцию:
```sql
BEGIN TRANSACTION / START TRANSACTION -- Postgresql
```
Для того чтобы закончить её:
```sql
END [TRANSACTION] / COMMIT -- Postgresql
```

==**Все операции обёрнуты в транзакции в любом случае**
ROLLBACK - откатить транзакцию
Внутри транзакции можно делать засечки (сэйвпоинты):
```pgsql
SAVEPOINT savepoint_name
....
ROLLBACK TO savepoint_name
```

Ограничения транзакций в PostgreSQL:
- Нельзя создавать транзакции в функциях
- Хотя функции неявно исполняются в рамках транзакции
- Чтобы прервать транзакцию изнутри функции - RAISE EXCEPTION
- Если хотим откатить только часть - можно "имитировать" savepoint c помощью BEGIN и EXCEPTION WHEN
- Концепция подразумевает, что уровнем изоляции и откатами управляет внешний код


==Изоляции транзакций - позволяет сделать так, чтобы параллельные транзакции не смогли изменить несогласованные данные.

Проблемы параллельности:
- =="грязное" чтение - чтение частичных изменений
![[Pasted image 20220408122509.png]]
-  ==неповторяемое чтение - повторное чтение показывает, что данные были изменены после первого чтения
![[Pasted image 20220408122654.png]]
- ==фантомное чтение - повторное чтение показывает другой результирующий набор (Разница от повторяемого чтения: в другой транзакции идут UPDATE, а в Фантомном - INSERT и DELETE)
![[Pasted image 20220408123240.png]]

- аномалия сериализации - результат параллельно выполняемых транзакций может не согласовываться с результатом этих же транзакций, выполнямых по очереди. 
*В примере у транзакций идут взаимные INSERT*
![[Pasted image 20220408123511.png]]


**Изоляция транзакций**


| Уровень изоляции                                  | "Грязное чтение"        | Неповторяемое чтение | Фантомное чтение        | Аномалия сериализации |
| ------------------------------------------------- | ----------------------- | -------------------- | ----------------------- | --------------------- |
| Read uncommited (Чтение незафиксированных данных) | Допускается, но не в PG | Возможно             | Возможно                | Возможно              |
| Read commited (Чтение зафиксированных данных)     | Невозможно              | Возможно             | Возможно                | Возможно              |
| Reapetable read (Повторяемое чтение)              | Невозможно              | Невозможно           | Допускается, но не в PG | Возможно              |
| Serializable (Сериализация)                       | Невозможно              | Невозможно           | Невозможно              | Невозможно            | 


Стоит понимать, что установленные уровни изоляции не исправляют проблемы параллельности, а лишь ловят ошибку и не дают транзакци